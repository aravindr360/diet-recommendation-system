<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Diet Recommender</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary-color: #2563eb;       /* Professional Blue */
      --primary-hover: #1d4ed8;
      --secondary-color: #64748b;     /* Slate Gray */
      --bg-color: #f1f5f9;            /* Light Gray Background */
      --card-bg: #ffffff;
      --text-color: #1e293b;
      --border-radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.5;
    }

    /* --- Layout Container --- */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* --- Header --- */
    header {
      text-align: center;
      margin-bottom: 40px;
    }
    h1 {
      font-size: 32px;
      font-weight: 700;
      color: #0f172a;
      margin: 0;
    }
    p.subtitle {
      color: var(--secondary-color);
      margin-top: 8px;
    }

    /* --- Control Panel (Form) --- */
    .control-panel {
      background: var(--card-bg);
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--secondary-color);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select, input {
      padding: 10px 12px;
      font-size: 15px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background-color: #f8fafc;
      transition: border-color 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary-color);
      background-color: #fff;
    }

    .button-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      border-top: 1px solid #e2e8f0;
      padding-top: 25px;
    }

    button {
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: all 0.2s;
    }

    #runBtn {
      background-color: var(--primary-color);
      color: white;
    }
    #runBtn:hover { background-color: var(--primary-hover); }

    #weeklyBtn {
      background-color: #10b981; /* Emerald Green */
      color: white;
    }
    #weeklyBtn:hover { background-color: #059669; }

    #downloadPdfBtn {
      background-color: #6366f1; /* Indigo */
      color: white;
      margin-left: auto; /* Push to right */
    }
    #downloadPdfBtn:hover { background-color: #4f46e5; }

    /* --- Status Bar --- */
    #status {
      font-weight: 600;
      color: var(--primary-color);
      min-height: 24px;
      margin-bottom: 20px;
      padding-left: 5px;
    }

    /* --- Result Cards --- */
    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
    }

    /* Section Heading for Days (e.g., MONDAY) */
    .cards-container h3 {
      grid-column: 1 / -1;
      margin-top: 30px;
      margin-bottom: 10px;
      font-size: 20px;
      color: #334155;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-3px);
    }

    .meal-badge {
      display: inline-block;
      background-color: #e0f2fe;
      color: #0369a1;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      align-self: flex-start;
    }

    .food-name {
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .meta {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 15px;
      line-height: 1.6;
      background: #f8fafc;
      padding: 8px;
      border-radius: 6px;
    }

    .labels-grid {
      margin-top: 15px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
      color: #475569;
      padding-top: 15px;
      border-top: 1px solid #f1f5f9;
    }
    .label-item b {
      color: #1e293b;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 160px;
    }

    /* Mobile tweak */
    @media (max-width: 768px) {
      .button-group { flex-direction: column; }
      #downloadPdfBtn { margin-left: 0; }
    }
  </style>
</head>

<body>

<div class="container">
  
  <header>
    <h1>Diet Recommendation System</h1>
    <p class="subtitle">AI-Powered Personalized Nutrition Plans</p>
  </header>

  <div class="control-panel">
    <div class="form-grid">
      
      <div class="form-group">
        <label for="disease">Health Condition</label>
        <select id="disease">
          <option value="diabetes">Diabetes</option>
          <option value="hypertension">Hypertension</option>
          <option value="cvd">Cardiovascular (CVD)</option>
          <option value="obesity">Obesity</option>
          <option value="pcos">PCOS</option>
        </select>
      </div>

      <div class="form-group">
        <label for="age">Age</label>
        <input id="age" type="number" value="30" />
      </div>

      <div class="form-group">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>

      <div class="form-group">
        <label for="bmi">BMI</label>
        <input id="bmi" type="number" step="0.1" value="22.0" />
      </div>

      <div class="form-group">
        <label for="pref">Dietary Preferences</label>
        <input id="pref" placeholder="e.g. veg, low-oil, dairy-free" />
      </div>

      <div class="form-group">
        <label for="cal">Daily Calorie Target</label>
        <input id="cal" type="number" value="1800" />
      </div>

    </div>

    <div class="button-group">
      <button id="runBtn">Generate Daily Diet</button>
      <button id="weeklyBtn">Generate Weekly Plan</button>
      <button id="downloadPdfBtn">Download PDF Report</button>
    </div>
  </div>

  <div id="status"></div>
  
  <div class="cards-container" id="cards"></div>

</div>

<script>
let lastWeeklyDiet = null;

const cards = document.getElementById("cards");
const status = document.getElementById("status");

// Using standard variables matching IDs
const disease = document.getElementById("disease");
const age = document.getElementById("age");
const gender = document.getElementById("gender");
const bmi = document.getElementById("bmi");
const pref = document.getElementById("pref");
const cal = document.getElementById("cal");
const runBtn = document.getElementById("runBtn");
const weeklyBtn = document.getElementById("weeklyBtn");
const downloadPdfBtn = document.getElementById("downloadPdfBtn");

function clearCards(){ cards.innerHTML = ""; }

function getFormData(){
  return {
    disease: disease.value,
    age: age.value,
    gender: gender.value,
    bmi: bmi.value,
    preferences: pref.value,
    daily_calorie: cal.value
  };
}

/* ---------- CARD WITH CHART ---------- */
function mkCard(meal, item){
  const div = document.createElement("div");
  div.className = "card";

  // Nicer HTML Structure inside the card
  div.innerHTML = `
    <div class="meal-badge">${meal.toUpperCase()}</div>
    <div class="food-name">${item.food || 'Unknown Item'}</div>
    
    <div class="meta">
      Calories: <b>${item.calories}</b> &bull; 
      P: ${item.protein}g &bull; 
      F: ${item.fat}g &bull; 
      C: ${item.carbs}g
    </div>

    <canvas></canvas>

    <div class="labels-grid">
      <div class="label-item">Diabetes: <b>${item.diabetes_label}</b></div>
      <div class="label-item">Hypertension: <b>${item.hypertension_label}</b></div>
      <div class="label-item" style="grid-column: 1/-1">CVD Safety: <b>${item.cvd_label}</b></div>
    </div>
  `;

  const ctx = div.querySelector("canvas").getContext("2d");

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Prot","Carbs","Fat","Sugar","Sodium"],
      datasets: [{
        label: 'Nutrients',
        data: [
          item.protein || 0,
          item.carbs || 0,
          item.fat || 0,
          item.sugar || 0,
          (item.sodium || 0)/10 // Scale down sodium for visibility
        ],
        backgroundColor: ["#3b82f6","#f97316","#ef4444","#64748b","#22c55e"],
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins:{ legend:{ display:false }, tooltip: { enabled: true } },
      scales:{ 
        y:{ display:false, beginAtZero: true },
        x:{ grid: {display: false} }
      },
      layout: { padding: { top: 10 } }
    }
  });

  return div;
}

/* ---------- API ---------- */
async function requestDiet(payload, weekly=false){
  const url = weekly ? "/get_weekly_diet" : "/get_diet";
  const r = await fetch(url,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  if (!r.ok) throw new Error("API Request Failed");
  return await r.json();
}

/* ---------- RUN ---------- */
async function run(weekly=false){
  clearCards();
  status.innerHTML = '<span style="color:#2563eb">Processing data... please wait.</span>';

  try {
    const data = await requestDiet(getFormData(), weekly);

    if(weekly){
      lastWeeklyDiet = data;
      for(const day in data){
        const h = document.createElement("h3");
        h.innerText = day.toUpperCase();
        cards.appendChild(h);

        ["breakfast","lunch","dinner"].forEach(m=>{
          if(data[day][m]) cards.appendChild(mkCard(m, data[day][m]));
        });
      }
    } else {
      ["breakfast","lunch","dinner"].forEach(m=>{
         if(data[m]) cards.appendChild(mkCard(m, data[m]));
      });
    }
    status.innerHTML = ''; // Clear loading text
  } catch (e) {
    status.innerHTML = `<span style="color:red">Error: ${e.message}</span>`;
  }
}

// Bind Events
runBtn.onclick = ()=>run(false);
weeklyBtn.onclick = ()=>run(true);

/* ---------- PDF DOWNLOAD ---------- */
downloadPdfBtn.onclick = async ()=>{
  if(!lastWeeklyDiet){
    alert("Please generate a weekly diet first.");
    return;
  }
  
  downloadPdfBtn.innerText = "Generating PDF...";
  
  try {
      const r = await fetch("/download_weekly_pdf",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({weekly_diet:lastWeeklyDiet})
      });

      const blob = await r.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "Personalized_Diet_Plan.pdf";
      a.click();
  } catch(e) {
      alert("Error downloading PDF");
  } finally {
      downloadPdfBtn.innerText = "Download PDF Report";
  }
};
</script>

</body>
</html>
