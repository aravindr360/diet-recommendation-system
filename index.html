<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Diet User Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- CSS STYLES --- */
    :root { --primary-color: #2563eb; --primary-hover: #1d4ed8; --secondary-color: #64748b; --bg-color: #f1f5f9; --card-bg: #ffffff; --text-color: #1e293b; --border-radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 80px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    header { text-align: center; margin-bottom: 40px; }
    h1 { font-size: 32px; color: #0f172a; margin: 0; }
    .subtitle { color: var(--secondary-color); margin-top: 8px; }
    
    .control-panel { background: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 30px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .form-group { display: flex; flex-direction: column; }
    label { font-size: 13px; font-weight: 600; color: var(--secondary-color); margin-bottom: 6px; text-transform: uppercase; }
    input, select { padding: 10px 12px; font-size: 15px; border: 1px solid #cbd5e1; border-radius: 8px; background-color: #f8fafc; }
    
    .button-group { display: flex; gap: 15px; flex-wrap: wrap; border-top: 1px solid #e2e8f0; padding-top: 25px; }
    button { padding: 12px 24px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; border-radius: 8px; color: white; background-color: var(--primary-color); transition: all 0.2s; }
    button:hover { background-color: var(--primary-hover); }
    #weeklyBtn { background-color: #10b981; }
    #downloadPdfBtn { background-color: #6366f1; margin-left: auto; }
    
    .cards-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); transition: transform 0.2s; }
    .card:hover { transform: translateY(-3px); }
    .meal-badge { background-color: #e0f2fe; color: #0369a1; font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 4px; margin-bottom: 10px; display:inline-block; }
    canvas { width: 100% !important; height: auto !important; max-height: 160px; }
    
    /* HISTORY MODAL STYLES */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; }
.modal-content { background: white; padding: 25px; border-radius: 12px; width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
.history-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
.history-info { font-size: 13px; color: #475569; }
.btn-load { background: #2563eb; color: white; padding: 5px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; }
.close-btn { background: #ef4444; float: right; padding: 5px 10px; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; }

    /* SUBMIT & STATUS BOXES */
    #doctorStatus { margin: 20px 0; padding: 20px; border-radius: 8px; display: none; text-align: center; }
    #submitSection { text-align: center; margin: 30px 0; display: none; padding: 20px; background: white; border-radius: 12px; border: 1px dashed #cbd5e1; }
    #submitBtn { background: #8b5cf6; }
    .logout { position: absolute; top: 20px; right: 20px; color: #ef4444; font-weight: bold; cursor: pointer; border: 1px solid #ef4444; padding: 5px 10px; border-radius: 6px; }
    
    /* CHATBOT */
    .chat-widget { position: fixed; bottom: 20px; right: 20px; width: 320px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 1000; overflow: hidden; }
    .chat-header { background: var(--primary-color); color: white; padding: 15px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; }
    .chat-body { height: 300px; overflow-y: auto; padding: 15px; background: #f8fafc; display: none; font-size: 13px; }
    .chat-input { display: none; border-top: 1px solid #e2e8f0; }
    .chat-input input { flex: 1; border: none; padding: 15px; outline: none; }
    .chat-input button { background: var(--primary-color); width: 70px; border-radius: 0; }
    .ai-msg { background: #e0f2fe; color: #0369a1; padding: 8px; border-radius: 8px; margin-bottom: 8px; }
    .user-msg { background: #2563eb; color: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; align-self: flex-end; text-align: right; }

/* 1. Make Cards look professional & Layout Charts */
.card {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
canvas { 
  width: 100% !important; 
  height: auto !important; 
  max-height: 160px; 
  margin-top: 10px;
}

/* 2. Medical Labels (Diabetes/BP) Styling */
.labels-grid {
  margin-top: 15px; 
  display: grid; 
  grid-template-columns: 1fr 1fr; 
  gap: 8px; 
  font-size: 11px; 
  color: #475569; 
  border-top: 1px solid #f1f5f9; 
  padding-top: 15px;
}

/* 3. The Yellow Snack Bar Styling */
.snack-bar {
  grid-column: 1 / -1; 
  margin-top: 10px;
  padding: 15px;
  background: #fffbeb; 
  border: 1px dashed #d97706; 
  border-radius: 12px;
  color: #92400e;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
}
  </style>
</head>

<body>

<div class="logout" onclick="logout()">Logout</div>

<div class="container">
  <header>
    <h1>User Dashboard</h1>
    <p class="subtitle">Personalized Medical Nutrition System</p>
  </header>

  <div class="control-panel">
    <div class="form-grid">
      <div class="form-group">
        <label>Height (cm)</label>
        <input id="height" type="number" placeholder="e.g. 170" oninput="calculateStats()">
      </div>
      <div class="form-group">
        <label>Weight (kg)</label>
        <input id="weight" type="number" placeholder="e.g. 70" oninput="calculateStats()">
      </div>
      <div class="form-group">
        <label>Your BMI</label>
        <input id="bmi" readonly style="background:#e2e8f0; color:#64748b;">
      </div>
      <div class="form-group">
        <label>Daily Calories</label>
        <input id="cal" readonly style="background:#e2e8f0; color:#64748b;">
      </div>
      
      <div class="form-group">
        <label>Health Condition</label>
        <select id="disease">
          <option value="diabetes">Diabetes</option>
          <option value="hypertension">Hypertension</option>
          <option value="cvd">Cardiovascular (CVD)</option>
          <option value="obesity">Obesity</option>
          <option value="pcos">PCOS</option>
        </select>
      </div>

      <div class="form-group">
        <label>Age</label>
        <input id="age" type="number" value="30">
      </div>
      <div class="form-group">
        <label>Gender</label>
        <select id="gender">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
      <div class="form-group">
        <label>Diet Preference</label>
        <select id="pref">
          <option value="non-veg">Non-Vegetarian</option>
          <option value="veg">Vegetarian</option>
        </select>
      </div>
    </div>
    <div class="form-group">
        <label>Regional Preference</label>
        <select id="region">
             <option value="All">All Regions (Mix)</option>
             <option value="South">South Indian</option>
             <option value="North">North Indian</option>
        </select>
    </div>

    <div class="button-group">
      <button id="runBtn" onclick="run(false)">Generate Daily Diet</button>
      <button id="weeklyBtn" onclick="run(true)">Generate Weekly Plan</button>
      <button onclick="openHistory()" style="background:#f59e0b;">üìú History</button>
      <button id="downloadPdfBtn">Download PDF Report</button>
    </div>
  </div>

 <div id="doctorStatus" style="display:none; margin: 20px 0; padding: 20px; border-radius: 8px; text-align: center;">
      </div>

  <div id="submitSection" style="display:none; text-align:center; margin: 20px 0; padding: 20px; border: 1px dashed #cbd5e1; border-radius: 12px;">
      <p style="color:#64748b; margin-bottom:10px; font-weight:600;">Satisfied with this plan?</p>
      <button id="submitBtn" onclick="submitToDoctor()" style="background:#8b5cf6; color:white; padding:12px 24px; border:none; border-radius:8px; cursor:pointer; font-size:16px;">
          üì§ Submit Plan to Doctor
      </button>
  </div>

  <div id="status"></div>
  <div class="cards-container" id="cards"></div>
</div>

<div class="chat-widget">
    <div class="chat-header" onclick="toggleChat()"><span>ü§ñ AI Nutritionist</span><span>&#9650;</span></div>
    <div class="chat-body" id="chatBody"><div class="ai-msg">Hello! I am your AI assistant. Ask me about nutrition.</div></div>
    <div class="chat-input" id="chatInputArea"><input type="text" id="aiQuery" placeholder="Ask a doubt..."><button onclick="askAI()">Send</button></div>
</div>
<div id="historyModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeHistory()">Close</button>
        <h2 style="margin-top:0;">Past Approved Diets</h2>
        <div id="historyList">Loading...</div>
    </div>
</div>
<script>
  
// --- 1. AUTHENTICATION CHECK ---
const currentUser = sessionStorage.getItem("currentUser");
if(!currentUser) {
    window.location.href = "/"; // Redirect to login if not logged in
}

// --- 2. GLOBAL VARIABLES ---
let lastWeeklyDiet = null;
let lastDailyDiet = null;
let isHistoryMode = false; // Flag to stop auto-updates
const cards = document.getElementById("cards");
const statusDiv = document.getElementById("status");

// --- 3. CALCULATE STATS ---
function calculateStats() {
    const h = parseFloat(document.getElementById('height').value);
    const w = parseFloat(document.getElementById('weight').value);
    if(h>0 && w>0) {
        document.getElementById('bmi').value = (w/((h/100)**2)).toFixed(1);
        document.getElementById('cal').value = Math.round((10*w + 6.25*h - 5*30 + 5)*1.2);
    } else {
        document.getElementById('bmi').value = ''; 
        document.getElementById('cal').value = '';
    }
}

// --- NEW FUNCTION: Discard Draft & Reload Approved ---
function restoreApproved() {
    if(confirm("Discard this new draft and reload your Approved Diet?")) {
        // Clear the local "New" plan
        lastWeeklyDiet = null;
        lastDailyDiet = null;
        
        // Clear the screen
        document.getElementById("cards").innerHTML = ""; 
        document.getElementById("submitSection").style.display = "none"; 
        
        // Run check immediately - this will trigger the "Auto-Load" logic
        // because now (userHasNewPlan) is false!
        checkDbStatus(); 
    }
}
// --- UPDATED STATUS CHECK (With Auto-Fill) ---
async function checkDbStatus() {
    if (isHistoryMode) return;
    try {
        const r = await fetch('/api/get_user_status', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: currentUser })
        });
        const data = await r.json();
        
        const box = document.getElementById('doctorStatus');
        const submitSection = document.getElementById('submitSection');

        // --- üü¢ NEW: AUTO-FILL LOGIC ---
        // Only fill if the input boxes are currently empty (so we don't annoy the user if they are typing)
        if (data.status !== "No Submission") {
            if (!document.getElementById('height').value && data.height) document.getElementById('height').value = data.height;
            if (!document.getElementById('weight').value && data.weight) document.getElementById('weight').value = data.weight;
            if (!document.getElementById('age').value && data.age) document.getElementById('age').value = data.age;
            if (!document.getElementById('disease').value && data.disease) document.getElementById('disease').value = data.disease;
            
            // Fill Calculated Fields directly from DB
            if (!document.getElementById('bmi').value && data.bmi) document.getElementById('bmi').value = data.bmi;
            if (!document.getElementById('cal').value && data.calories) document.getElementById('cal').value = data.calories;
        }
        // -------------------------------

        // FLAG: User has generated a NEW plan locally?
        const userHasNewPlan = (lastWeeklyDiet || lastDailyDiet);

        // --- 1. HANDLE HISTORY (STATUS BOX) ---
        if (data.status === "No Submission") {
            if(box) box.style.display = "none";
        } 
        else {
            if(box) {
                box.style.display = "block";
                
                if (data.status === "Pending Review") {
                    box.style.background = "#fffbeb"; box.style.border = "1px solid #f59e0b"; box.style.color = "#92400e";
                    box.innerHTML = `<h3>üïí Pending Review</h3><p>Your previous submission is waiting for the doctor.</p>`;
                } 
                else if (data.status === "Approved") {
                    box.style.background = "#dcfce7"; box.style.border = "1px solid #22c55e"; box.style.color = "#166534";
                    
                    let restoreBtn = "";
                    if(userHasNewPlan) {
                        restoreBtn = `<div style="margin-top:10px; border-top:1px solid #86efac; padding-top:10px;">
                            <span style="font-size:12px; font-weight:bold;">‚ö†Ô∏è You are viewing a New Draft.</span><br>
                            <button onclick="restoreApproved()" style="margin-top:5px; background:#16a34a; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px;">
                                ‚Ü© View Original Approved Plan
                            </button>
                        </div>`;
                    }

                    box.innerHTML = `<h3>‚úÖ Last Plan: Approved</h3><p><b>Doctor's Note:</b> ${data.doctor_comment}</p>${restoreBtn}`;
                } 
                else if (data.status === "Rejected") {
                    box.style.background = "#fee2e2"; box.style.border = "1px solid #ef4444"; box.style.color = "#991b1b";
                    box.innerHTML = `<h3>‚ùå Last Plan: Rejected</h3><p><b>Reason:</b> ${data.doctor_comment}</p>`;
                }
            }
        }

        // --- 2. HANDLE NEW SUBMISSION (BUTTON) ---
        if (userHasNewPlan && submitSection) {
            submitSection.style.display = "block";
        } else if (submitSection) {
            submitSection.style.display = "none";
        }

        // --- 3. AUTO-LOAD (Only if NOT looking at a new plan) ---
        if (!userHasNewPlan && data.diet_plan && document.getElementById("cards").innerHTML === "") {
             const savedPlan = data.diet_plan;
             if(savedPlan["Mon"]) {
                 renderWeekly(savedPlan);
             } else {
                 renderDaily(savedPlan["Today"] || savedPlan);
             }
        }

    } catch(e) { console.log("DB Check error", e); }
}
setInterval(checkDbStatus, 3000); // Poll every 3s

// --- 5. GENERATE DIET ---
async function run(weekly){
  document.getElementById("cards").innerHTML = "<p style='text-align:center; color:#2563eb;'>Generating new plan...</p>";
    cards.innerHTML = "<p style='text-align:center; color:#2563eb; font-weight:bold;'>Generating your AI Diet Plan...</p>";
    statusDiv.innerHTML = "";
    
    const payload = {
        disease: document.getElementById('disease').value,
        age: document.getElementById('age').value,
        preferences: document.getElementById('pref').value,
        region: document.getElementById('region').value,
        daily_calorie: document.getElementById('cal').value || 2000
    };
    
    const url = weekly ? "/get_weekly_diet" : "/get_diet";
    
    try {
        const r = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
        const data = await r.json();
        
        if(weekly) {
            lastWeeklyDiet = data; lastDailyDiet = null;
            renderWeekly(data);
        } else {
            lastDailyDiet = data; lastWeeklyDiet = null;
            renderDaily(data);
        }
        
        // Trigger status check to reveal Submit button
        checkDbStatus(); 
        
    } catch(e) {
        cards.innerHTML = `<p style="color:red; text-align:center;">Error: ${e.message}</p>`;
    }
}
// --- 6. SUBMIT TO DOCTOR ---
async function submitToDoctor() {
    // 1. Get Height & Weight from HTML inputs
    // (Make sure your HTML inputs have id="height" and id="weight")
    const h = document.getElementById('height').value;
    const w = document.getElementById('weight').value;
    
    // 2. Auto-Calculate BMI
    // Formula: Weight / (Height in meters * Height in meters)
    let bmiValue = 0;
    if (h && w) {
        let h_meters = h / 100;
        bmiValue = (w / (h_meters * h_meters)).toFixed(1); // Round to 1 decimal
    }

    // 3. Prepare the Plan
    const plan = lastWeeklyDiet ? lastWeeklyDiet : { "Today": lastDailyDiet };
    
    // 4. Create the Payload with ALL details
    const payload = {
        username: currentUser,
        disease: document.getElementById('disease').value,
        age: document.getElementById('age').value,
        height: h,          // <--- Sent to DB
        weight: w,          // <--- Sent to DB
        bmi: bmiValue,      // <--- Sent to DB
        calories: document.getElementById('cal').value,
        diet_plan: plan
    };
    
    // 5. Send to Server
    const btn = document.getElementById('submitBtn');
    btn.innerText = "Sending...";
    
    try {
        await fetch('/api/submit_diet', {
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify(payload)
        });
        
        alert("Sent to Doctor! Please wait for approval.");
        btn.innerText = "üì§ Submit to Doctor";
        checkDbStatus(); // Refresh immediately
    } catch (error) {
        console.error(error);
        alert("Error sending to doctor.");
        btn.innerText = "üì§ Submit to Doctor";
    }
}
/* --- REPLACE YOUR CURRENT getBadgeInfo WITH THIS --- */
function getBadgeInfo(dailySum, goal) {
    // 1. Get the disease to check for Obesity logic
    const disease = document.getElementById('disease').value.toLowerCase();

    if (!goal || goal === 0) return { color: "#0369a1", bg: "#e0f2fe", text: `‚ÑπÔ∏è Total: ${dailySum} kcal` };
    
    // 2. SPECIAL LOGIC FOR OBESITY (Fat Loss Zone)
    if (disease === "obesity") {
        const deficit = goal - dailySum;
        
        // If deficit is huge (>1200), that's unsafe starvation
        if (deficit > 1200) return { color: "#ca8a04", bg: "#fef9c3", text: `‚ö†Ô∏è ${dailySum} (Too Low - Eat More)` };
        
        // If deficit is healthy (300+), that's GOOD!
        else if (deficit >= 300) return { color: "#16a34a", bg: "#dcfce7", text: `‚úÖ ${dailySum} kcal (Fat Loss Zone üî•)` };
        
        // If eating more than goal, that's bad
        else if (dailySum > goal) return { color: "#dc2626", bg: "#fee2e2", text: `‚ö†Ô∏è ${dailySum} (Overeating)` };
        
        // Maintenance
        else return { color: "#0369a1", bg: "#e0f2fe", text: `‚ÑπÔ∏è ${dailySum} (Maintenance)` };
    }

    // 3. STANDARD LOGIC (For Diabetes, etc.)
    if (dailySum < goal - 400) return { color: "#ca8a04", bg: "#fef9c3", text: `‚ö†Ô∏è ${dailySum}/${goal} (Low)` }; 
    else if (dailySum > goal + 400) return { color: "#dc2626", bg: "#fee2e2", text: `‚ö†Ô∏è ${dailySum}/${goal} (High)` }; 
    else return { color: "#16a34a", bg: "#dcfce7", text: `‚úÖ ${dailySum}/${goal} (Perfect)` }; 
}

// 2. HELPER: Draw the Yellow Snack Bar
function drawSnackBar(snackItem) {
    if (!snackItem) return;
    const div = document.createElement("div");
    div.className = "snack-bar";
    div.innerHTML = `
        <span style="font-size:24px;">üçé</span>
        <div>
            <b>Recommended Snack:</b> ${snackItem.food} 
            <span style="background:#fff; padding:2px 8px; border-radius:4px; border:1px solid #d97706; margin-left:8px; font-size:12px;">
                ${snackItem.calories} kcal
            </span>
        </div>
    `;
    document.getElementById("cards").appendChild(div);
}

// 3. HELPER: Better Icons
function getIcon(n) { return n.includes("Chicken")?"üçó": n.includes("Egg")?"ü•ö": n.includes("Rice")?"üçö": n.includes("Fish")?"üêü": n.includes("Fruit")?"üçé": "üç≤"; }

// 4. MAIN CARD CREATOR (Restores Charts & Labels)
function mkCard(meal, item){
  const div = document.createElement("div");
  div.className = "card";
  
  div.innerHTML = `
    <div class="meal-badge">${meal.toUpperCase()}</div>
    <div style="font-size: 40px; text-align: center; margin-bottom: 5px;">${getIcon(item.food)}</div>
    <div style="font-size:18px; font-weight:700; text-align: center; margin-bottom: 8px;">${item.food}</div>
    <div style="font-size: 13px; color: #64748b; background: #f8fafc; padding: 8px; border-radius: 6px; margin-bottom: 10px; text-align:center;">
        Calories: <b>${item.calories}</b> &bull; P: ${item.protein}g &bull; F: ${item.fat}g &bull; C: ${item.carbs}g
    </div>
    <canvas></canvas>
    <div class="labels-grid">
      <div>Diabetes: <b>${item.diabetes_label || 'Safe'}</b></div>
      <div>BP: <b>${item.hypertension_label || 'Safe'}</b></div>
      <div style="grid-column: 1/-1">CVD Safety: <b>${item.cvd_label || 'Safe'}</b></div>
    </div>
  `;

  // Restore the Chart
  setTimeout(() => {
    new Chart(div.querySelector("canvas").getContext("2d"), {
      type: "bar",
      data: {
        labels: ["Prot","Carbs","Fat","Sugar","Sodium"],
        datasets: [{ 
            data: [item.protein||0, item.carbs||0, item.fat||0, item.sugar||0, (item.sodium||0)/100], 
            backgroundColor: ["#3b82f6","#f97316","#ef4444","#64748b","#22c55e"], 
            borderRadius: 4 
        }]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        plugins:{legend:{display:false}}, 
        scales:{y:{display:false}, x:{grid:{display:false}}} 
      }
    });
  }, 0);
  
  return div;
}

// 5. RENDER WEEKLY (Restores Headers & Badges)
function renderWeekly(data) {
    const c = document.getElementById("cards"); 
    c.innerHTML = "";
    const goal = Number(document.getElementById('cal').value) || 0;
    
    const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    days.forEach(day => {
        if(!data[day]) return;

        // Calculate Totals for Badge
        let dailySum = 0;
        ['breakfast','lunch','dinner'].forEach(m => { if(data[day][m]) dailySum += data[day][m].calories; });
        if(data[day].snack) dailySum += data[day].snack.calories;
        const badge = getBadgeInfo(dailySum, goal);

        // Header with Badge
        const head = document.createElement("div");
        head.style.gridColumn = "1/-1"; 
        head.style.borderBottom = "2px solid #e2e8f0"; 
        head.style.marginTop = "30px"; 
        head.style.paddingBottom = "5px";
        head.style.display = "flex";
        head.style.justifyContent = "space-between";
        head.style.alignItems = "center";
        head.innerHTML = `
            <h3 style="color:#1e293b; margin:0;">${day.toUpperCase()}</h3>
            <div style="font-size:13px; font-weight:bold; color:${badge.color}; background:${badge.bg}; padding:6px 12px; border-radius:20px;">${badge.text}</div>
        `;
        c.appendChild(head);
        
        ["breakfast","lunch","dinner"].forEach(m => { if(data[day][m]) c.appendChild(mkCard(m, data[day][m])); });
        if(data[day].snack) drawSnackBar(data[day].snack);
    });
}

// 6. RENDER DAILY (Restores Snack Bar)
function renderDaily(data) {
    const c = document.getElementById("cards"); 
    c.innerHTML = "";
    
    // 1. Calculate Total Calories for the day
    let dailySum = 0;
    ["breakfast","lunch","dinner"].forEach(m => { if(data[m]) dailySum += data[m].calories; });
    if(data.snack) dailySum += data.snack.calories;
    
    // 2. Get the Badge (Perfect/Fat Loss/Low)
    const goal = Number(document.getElementById('cal').value) || 0;
    const badge = getBadgeInfo(dailySum, goal);
    
    // 3. Display the Status Badge above the cards
    // We use the 'status' div which sits right above the cards container
    const statusDiv = document.getElementById("status");
    if(statusDiv) {
        statusDiv.innerHTML = `<div style="background:${badge.bg}; padding:15px; border-radius:8px; text-align:center; font-size:16px; border:1px solid ${badge.color}; color:${badge.color}; margin-bottom: 20px; font-weight:bold;">${badge.text}</div>`;
    }

    // 4. Draw Cards
    ["breakfast","lunch","dinner"].forEach(m => { if(data[m]) c.appendChild(mkCard(m, data[m])); });
    
    // 5. Draw Snack
    if(data.snack) drawSnackBar(data.snack);
}

// --- 8. PDF DOWNLOAD (FIXED) ---
document.getElementById('downloadPdfBtn').onclick = async () => {
    let pdfData = null;
    if (lastWeeklyDiet) pdfData = lastWeeklyDiet;
    else if (lastDailyDiet) pdfData = { "Today's Plan": lastDailyDiet }; 
    else { alert("Please generate a diet plan first!"); return; }

    const btn = document.getElementById('downloadPdfBtn');
    btn.innerText = "Generating PDF...";
    try {
        const r = await fetch("/download_weekly_pdf", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({weekly_diet: pdfData})});
        const blob = await r.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "Personalized_Diet_Plan.pdf";
        a.click();
    } catch(e) { alert("Error downloading PDF"); } 
    finally { btn.innerText = "Download PDF Report"; }
};

// --- 9. CHATBOT LOGIC ---
function toggleChat() {
    const b = document.getElementById('chatBody');
    const i = document.getElementById('chatInputArea');
    const isHidden = b.style.display === 'none' || b.style.display === '';
    b.style.display = isHidden ? 'block' : 'none';
    i.style.display = isHidden ? 'flex' : 'none';
}
async function askAI() {
    const q = document.getElementById('aiQuery').value;
    if(!q) return;
    document.getElementById('chatBody').innerHTML += `<div class="user-msg">${q}</div>`;
    document.getElementById('aiQuery').value = "";
    
    // Auto-scroll
    const chatBody = document.getElementById('chatBody');
    chatBody.scrollTop = chatBody.scrollHeight;

    const r = await fetch('/chat_ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:q, context:"Patient"})});
    const d = await r.json();
    document.getElementById('chatBody').innerHTML += `<div class="ai-msg">${d.reply}</div>`;
    chatBody.scrollTop = chatBody.scrollHeight;
}

function logout() { sessionStorage.clear(); window.location.href = "/"; }

// --- HISTORY FUNCTIONS ---
async function openHistory() {
    document.getElementById("historyModal").style.display = "flex";
    const list = document.getElementById("historyList");
    list.innerHTML = "Loading records...";

    try {
        const r = await fetch('/api/user_history', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: currentUser })
        });
        const data = await r.json();

        if (data.length === 0) {
            list.innerHTML = "<p>No approved history found.</p>";
            return;
        }

        let html = "";
        data.forEach(item => {
            const planString = encodeURIComponent(JSON.stringify(item.diet_plan));
            
            html += `
            <div class="history-item">
                <div class="history-info">
                    <b>Date:</b> ${item.timestamp}<br>
                    <b>Note:</b> ${item.doctor_comment}
                </div>
                <button class="btn-load" onclick="loadHistoricalPlan('${planString}')">üìÇ Load This Plan</button>
            </div>`;
        });
        list.innerHTML = html;
    } catch(e) {
        list.innerHTML = "Error fetching history.";
    }
}

function closeHistory() {
    document.getElementById("historyModal").style.display = "none";
}

function loadHistoricalPlan(planString) {
    // üü¢ 1. Turn ON History Mode (Stops background updates)
    isHistoryMode = true; 

    const plan = JSON.parse(decodeURIComponent(planString));
    
    // Update Global Variables so PDF works
    if (plan["Mon"]) {
        lastWeeklyDiet = plan;
        lastDailyDiet = null;
        renderWeekly(plan);
    } else {
        lastDailyDiet = plan["Today"] || plan;
        lastWeeklyDiet = null;
        renderDaily(lastDailyDiet);
    }

    // Update UI to show this is a loaded plan
    const box = document.getElementById('doctorStatus');
    const submitSection = document.getElementById('submitSection');
    
    // Hide "Submit" button (You can't submit old history)
    if(submitSection) submitSection.style.display = "none";

    box.style.display = "block";
    box.style.background = "#e0f2fe"; 
    box.style.border = "1px solid #2563eb";
    box.style.color = "#1e40af";
    
    // üü¢ 2. Add the "Back" Button
    box.innerHTML = `
        <h3>üìÇ Loaded from History</h3>
        <p>You are viewing a past approved plan.</p>
        <button onclick="exitHistoryMode()" style="margin-top:10px; background:#2563eb; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold;">
            ‚Ü© Back to Live Dashboard
        </button>
    `;
    
    closeHistory();
}

// üü¢ 3. NEW FUNCTION: Exit History Mode
function exitHistoryMode() {
    isHistoryMode = false; // Allow updates again
    
    // Clear screen
    document.getElementById("cards").innerHTML = "";
    document.getElementById('doctorStatus').style.display = "none";
    
    // Reset variables
    lastWeeklyDiet = null;
    lastDailyDiet = null;

    // Refresh immediately to show current DB status
    checkDbStatus();
}
</script>
</body>
</html>